<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>마이페이지</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <link rel="stylesheet" href="/css/mypage.css">
</head>
<body>

<div class="container">
    <header class="header">
        <h1>OMG</h1>
    </header>

    <div class="main-content">
        <div class="user-info">
            <img src="/files/user.png" alt="Profile Picture">
            <p><span th:text="${user.usernick}"></span>님</p>
            <a href="/my/profile" class="link-button">프로필 편집</a>
            <input type="hidden" id="userId" name="userId" th:value="${user.getId()}">
        </div>

        <div class="navigation">
            <a href="#" data-target="my-trip">나의 일정</a>
            <a href="#" data-target="trip-info">일행 모집</a>
            <a href="#" data-target="review-section">내 여행 후기</a>
            <a href="#" data-target="my-wishlist">찜</a>
        </div>

        <div class="my-trip">
            <h3>나의 일정</h3>
        </div>

        <div class="trip-info">
            <h3>일행 모집</h3>
        </div>

        <div class="review-section">
            <h3>내 여행 후기</h3>
        </div>

        <div class="my-wishlist">
            <h3>찜</h3>
        </div>

        <a href="/" class="link-button light-button">돌아가기</a>
    </div>
</div>

<script>
    const userId = document.getElementById('userId').value;

    $(document).ready(function() {
        $('.navigation a').click(function(event) {
            event.preventDefault();
            const target = $(this).data('target');

            $('.my-trip, .trip-info, .review-section, .my-wishlist').hide();

            if (target === "my-trip") {
                loadMyTrip(userId);
            } else if (target === "trip-info") {
                loadTripInfo(userId);
            } else if (target === "review-section") {
                loadReviewSection(userId);
            } else if (target === "my-wishlist") {
                loadWishlist();
            }
        });

        // 나의 일정
        function loadMyTrip(userId) {
            $.ajax({
                url: `/api/trips/user/${userId}`,
                method: 'GET',
                dataType: 'json',
                success: function(data) {
                    console.log("Data received:", data);
                    $('.my-trip').empty().append('<h3>나의 일정</h3>');

                    if (data.length > 0) {
                        data.forEach(function(item) {
                            const startDate = new Date(item.startDate).toLocaleDateString('ko-KR');
                            const endDate = new Date(item.endDate).toLocaleDateString('ko-KR');

                            const tripItem = `
                                <div class="trip-item">
                                    <h2>${item.tripName}</h2>
                                    <p>시작 날짜: ${startDate}</p>
                                    <p>종료 날짜: ${endDate}</p>
                                    <p>도시: ${item.city.name}</p>
                                    <button class="chat-button" onclick="window.location.href='/trip/${item.id}'">세부 정보 보기</button>
                                </div>
                            `;
                            $('.my-trip').append(tripItem);
                        });
                    } else {
                        $('.my-trip').html('<p>해당 사용자의 여행 일정이 없습니다.</p>');
                    }

                    $('.my-trip').show();
                },
                error: function(xhr, status, error) {
                    console.error("일정을 불러오는 데 실패했습니다. :", error);
                    $('.my-trip').html('<p>일정을 불러오는 데 실패했습니다.</p>').show();
                }
            });
        }

        // 일행 모집 글 목록 나열
        function loadTripInfo(userId) {
            $.ajax({
                url: `/api/joinPosts/user/${userId}`,
                method: 'GET',
                dataType: 'json',
                success: function(data) {
                    console.log("Data received:", data);
                    $('.trip-info').empty().append('<h3>일행 모집</h3>');

                    if (data.length > 0) {
                        data.forEach(function(post) {
                            const postItem = `
                                <div class="post-item">
                                    <h2>${post.title}</h2>
                                    <p>작성자: ${post.usernick}</p>
                                    <p>${post.content}</p>
                                    <button class="chat-button" onclick="window.location.href='/joinPost/${post.id}'">자세히 보기</button>
                                </div>
                            `;
                            $('.trip-info').append(postItem);
                        });
                    } else {
                        $('.trip-info').html('<p>현재 모집 중인 일정이 없습니다.</p>');
                    }

                    $('.trip-info').show();
                },
                error: function(xhr, status, error) {
                    console.error("일정 모집 데이터를 불러오는 데 실패했습니다. :", error);
                    $('.trip-info').html('<p>일정 모집 데이터를 불러오는 데 실패했습니다.</p>').show();
                }
            });
        }

        // 여행 후기 글 목록 나열
        function loadReviewSection(userId) {
            $.ajax({
                url: `/api/reviewPosts/user/${userId}`,
                method: 'GET',
                dataType: 'json',
                success: function(data) {
                    console.log("Data received:", data);
                    $('.review-section').empty().append('<h3>내 여행 후기</h3>');

                    if (data.length > 0) {
                        data.forEach(function(review) {
                            const reviewItem = `
                                <div class="review-item">
                                    <h2>${review.title}</h2>
                                    <p>작성자: ${review.usernick}</p>
                                    <p>${review.content}</p>
                                    <button class="chat-button" onclick="window.location.href='/reviewPost/${review.id}'">자세히 보기</button>
                                </div>
                            `;
                            $('.review-section').append(reviewItem);
                        });
                    } else {
                        $('.review-section').html('<p>작성된 여행 후기가 없습니다.</p>');
                    }

                    $('.review-section').show();
                },
                error: function(xhr, status, error) {
                    console.error("여행 후기 데이터를 불러오는 데 실패했습니다. :", error);
                    $('.review-section').html('<p>여행 후기 데이터를 불러오는 데 실패했습니다.</p>').show();
                }
            });
        }

        // 찜 목록 나열
    });
</script>
</body>
</html>