<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>여행 일정 생성</title>
    <link rel="stylesheet" href="/css/trip.css">
    <link rel="stylesheet" href="/css/map.css">
    <link rel="stylesheet" href="/css/recommend.css">

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

</head>
<body>
<div class="container">
    <!-- 여행 일정 생성 영역 -->
    <div class="form_wrap">
        <a href="/" class="backLink">↩️ 메인 화면</a>
        <form id="tripForm">
            <h1>여행 일정 생성</h1>
            <label for="tripName">여행 이름</label>
            <input type="text" id="tripName" name="tripName" placeholder="여행 이름을 입력해주세요" required><br>

            <label for="startDate">여행 시작일</label>
            <input type="date" id="startDate" name="startDate" required onchange="updateTripDates()"><br>

            <label for="endDate">여행 종료일</label>
            <input type="date" id="endDate" name="endDate" required onchange="updateTripDates()"><br>

            <label for="regionSelect">지역 선택</label>
            <select id="regionSelect" onchange="updateCities()">
                <option value="">지역을 선택해주세요</option>
                <option value="특별시/광역시">특별시/광역시</option>
                <option value="강원도">강원도</option>
                <option value="경기도">경기도</option>
                <option value="경상남도">경상남도</option>
                <option value="경상북도">경상북도</option>
                <option value="충청남도">충청남도</option>
                <option value="충청북도">충청북도</option>
                <option value="전라남도">전라남도</option>
                <option value="전라북도">전라북도</option>
                <option value="제주특별자치도">제주도</option>
            </select><br>

            <label for="citySelect">도시 선택</label>
            <select id="citySelect" name="cityId" required>
                <option value="">도시를 선택해주세요</option>
            </select><br>
            <input type="hidden" id="cityId" name="cityId" required>

            <h2>세부 일정</h2>
            <div id="tripDates"></div>

            <button type="submit">일정 생성</button>
        </form>
    </div>

    <!-- 지도 영역 -->
    <div class="map_wrap">
        <div id="map"></div>

        <!-- 검색 메뉴 컨테이너 -->
        <div id="menu_wrap" class="bg_white">
            <div class="option">
                <div>
                    <!-- 검색 폼 제출 시 searchPlaces() 호출 -->
                    <form onsubmit="searchPlaces(); return false;">
                        <input type="text" placeholder="장소명을 입력해주세요." id="keyword" size="15">
                        <button type="submit" id="searchBtn">검색하기</button>
                    </form>
                    <button type="button" id="closeBtn">창 닫기</button>
                </div>
            </div>

            <hr>
            <!-- 장소 목록을 표시할 리스트 -->
            <ul id="placesList"></ul>
            <!-- 페이지네이션을 표시 -->
            <div id="pagination"></div>
        </div>

        <!-- 필터링 버튼 및 결과 창 -->
        <button id="toggleButton" class="toggleButton">접기</button> <!-- 접기/펼치기 버튼을 창 밖으로 이동 -->
        <div class="filter_wrap" id="filter_wrap">
            <h3 id="filterTitle">여행 명소 추천</h3> <!-- 제목 추가 -->
            <div id="filterContent">
                <div id="filterButtons">
                    <button type="button" onclick="filterPlaces(12)">관광지</button>
                    <button type="button" onclick="filterPlaces(39)">식당</button>
                    <button type="button" onclick="filterPlaces(32)">숙박</button>
                    <button type="button" onclick="filterPlaces(14)">문화시설</button>
                    <button type="button" onclick="filterPlaces(15)">축제/행사</button>
                    <button type="button" onclick="filterPlaces(28)">레포츠</button>
                    <button type="button" onclick="filterPlaces(38)">쇼핑</button>
                </div>
                <br>
                <hr>
                <div id="filteredPlacesListContainer">
                    <ul id="filteredPlacesList"></ul>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    const regions = {
        "특별시/광역시": ["서울", "부산", "대구", "인천", "광주", "대전", "울산", "세종"],
        "강원도": ["춘천", "원주", "강릉", "동해", "태백", "속초", "삼척", "홍천", "횡성", "평창", "정선", "영월"],
        "경기도": ["수원", "고양", "용인", "성남", "부천", "남양주", "안산", "안양", "평택", "의정부", "군포", "오산", "시흥", "하남", "의왕", "양주", "파주", "광명", "구리", "여주"],
        "경상남도": ["창원", "김해", "진주", "양산", "거제", "통영", "사천", "밀양", "함안", "거창", "창녕", "산청", "의령", "고성", "하동", "합천"],
        "경상북도": ["포항", "경주", "구미", "김천", "안동", "영주", "상주", "문경", "경산", "영천", "청송", "영양", "봉화", "울릉", "예천", "성주", "군위", "의성"],
        "충청남도": ["천안", "아산", "서산", "논산", "보령", "계룡", "당진", "금산", "부여", "서천", "홍성", "예산", "청양", "태안"],
        "충청북도": ["청주", "충주", "제천", "보은", "옥천", "영동"],
        "전라남도": ["여수", "순천", "목포", "나주", "광양", "담양", "곡성", "구례", "고흥", "보성", "장흥", "강진", "해남", "완도", "진도", "신안", "무안", "영암"],
        "전라북도": ["전주", "군산", "익산", "남원", "정읍", "김제", "완주", "진안", "무주", "장수", "고창", "임실", "순창"],
        "제주특별자치도": ["제주", "서귀포"]
    };

    let markers = {};
    let selectedDateDiv = null;
    let selectedPlaces = {};
    let selectedCityName = '';  // 전역 변수로 selectedCityName 정의

    // 도시 선택 시 선택된 도시 이름 저장
    document.getElementById('citySelect').addEventListener('change', function() {
        selectedCityName = this.value;  // 도시 선택 시 selectedCityName에 값 저장
        console.log('Selected city:', selectedCityName);
    });

    function updateCities() {
        const regionSelect = document.getElementById('regionSelect');
        const citySelect = document.getElementById('citySelect');
        const selectedRegion = regionSelect.value;

        citySelect.innerHTML = '<option value="">도시를 선택하세요</option>';

        if (selectedRegion && regions[selectedRegion]) {
            regions[selectedRegion].forEach(cityName => {
                const option = document.createElement('option');
                option.value = cityName;
                option.textContent = cityName;
                citySelect.appendChild(option);
            });
        }
    }

    function filterPlaces(contentTypeId) {
        if (!selectedCityName) {
            alert('먼저 도시를 선택하세요.');
            return;
        }

        // 기본 설정
        const serviceKey = "bR6YX%2Fkp0Y%2Bvm31sUAayaUZjxmI7dVH0PTsTtlb90Ae9abKUTxIFBc7X4u1wnHnDUuk8uYekiXhdYgb5iyiw5w%3D%3D";  // 발급받은 서비스 키를 사용하세요
        const numOfRows = 10;  // 한 페이지에 표시할 결과 수
        const pageNo = 1;  // 페이지 번호
        const MobileOS = "ETC";  // 운영체제 정보
        const MobileApp = "MyTourApp";  // 애플리케이션 이름

        // API 호출 URL 구성
        const apiUrl = `https://api.visitkorea.or.kr/openapi/service/rest/KorService/searchKeyword?serviceKey=${serviceKey}&MobileOS=${MobileOS}&MobileApp=${MobileApp}&_type=json&listYN=Y&arrange=A&keyword=${encodeURIComponent(selectedCityName)}&contentTypeId=${contentTypeId}&numOfRows=${numOfRows}&pageNo=${pageNo}`;

        // API 호출 URL을 콘솔에 출력
        console.log('API 호출 URL:', apiUrl);

        // API 호출
        fetch(apiUrl)
            .then(response => response.json())
            .then(data => {
                console.log('API 응답 데이터:', data);
                if (data.response && data.response.body && data.response.body.items) {
                    displayFilteredPlaces(data.response.body.items.item);
                } else {
                    alert('검색 결과가 없습니다.');
                }
            })
            .catch(error => {
                console.error('Error fetching data:', error);
                alert('데이터를 불러오는데 실패했습니다.');
            });
    }

    function displayFilteredPlaces(places) {
        const listEl = document.getElementById('filteredPlacesList');
        listEl.innerHTML = '';

        if (!places || places.length === 0) {
            listEl.innerHTML = '<li>검색 결과가 없습니다.</li>';
            return;
        }

        places.forEach(place => {
            const imageUrl = place.firstimage || 'https://via.placeholder.com/100';  // 기본 이미지 사용
            const phone = place.tel || '전화번호 없음';
            const address1 = place.addr1 || '주소 없음';

            const itemEl = document.createElement('li');
            itemEl.innerHTML = `
            <img src="${imageUrl}" alt="${place.title}">
            <div class="place-info">
                <h3>${place.title}</h3>
                <p><strong>전화번호:</strong> ${phone}</p>
                <p><strong>주소:</strong> ${address1}</p>
            </div>
            `;
            listEl.appendChild(itemEl);
        });
    }

    document.getElementById('tripForm').addEventListener('submit', function (event) {
        event.preventDefault();

        const tripName = document.getElementById('tripName').value;
        const startDate = document.getElementById('startDate').value;
        const endDate = document.getElementById('endDate').value;
        const cityId = parseInt(document.getElementById('cityId').value, 10);

        const tripDates = [];
        document.querySelectorAll('.tripDate').forEach(function (tripDateElement) {
            const tripDate = tripDateElement.querySelector('input[name="tripDate"]').value;

            const tripLocations = [];
            tripDateElement.querySelectorAll('.locations').forEach(function (locationElement) {
                const placeName = locationElement.querySelector('input[name="placeName"]').value;
                const latitude = locationElement.querySelector('input[name="latitude"]').value;
                const longitude = locationElement.querySelector('input[name="longitude"]').value;

                tripLocations.push({ placeName, latitude, longitude });
                console.log(`Location added: ${placeName}, ${latitude}, ${longitude}`);
            });

            tripDates.push({ tripDate, tripLocations });
            console.log(`TripDate added: ${tripDate} with locations: ${JSON.stringify(tripLocations)}`);
        });

        const data = {
            tripName,
            startDate,
            endDate,
            cityId,
            tripDates
        };

        console.log('서버로 데이터 전송:', JSON.stringify(data));

        fetch('/api/trips', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(data)
        })
            .then(response => response.json().then(data => {
                if (!response.ok) {
                    throw new Error(data.error);
                }
                return data;
            }))
            .then(data => {
                alert(data.message);
                console.log('Success:', data);
                window.location.href = '/';
            })
            .catch(error => {
                alert(error.message);
                console.error('Error:', error);
            });
    });

    function updateTripDates() {
        const startDate = document.getElementById('startDate').value;
        const endDate = document.getElementById('endDate').value;

        // 시작 날짜와 종료 날짜가 모두 존재하는지 확인
        if (startDate && endDate) {
            const start = new Date(startDate);
            const end = new Date(endDate);
            const tripDates = document.getElementById('tripDates');
            tripDates.innerHTML = '';

            for (let date = new Date(start), dayCount = 1; date <= end; date.setDate(date.getDate() + 1), dayCount++) {
                const tripDateHtml = `
                    <div class="tripDate">
                        <div class="dayHeader" onclick="toggleTripDate(this)">
                            <span class="dayCountLabel">Day ${dayCount}</span>
                            <span> ${date.toISOString().split('T')[0]}</span>
                        </div>
                        <div class="dayContent">
                            <input type="hidden" name="tripDate" value="${date.toISOString().split('T')[0]}" required readonly><br>
                        </div>
                        <div class="dayLocation">
                        </div>
                        <button type="button" onclick="addLocation(this)">장소 추가</button>
                    </div>
                `;
                tripDates.insertAdjacentHTML('beforeend', tripDateHtml);
                console.log(`TripDate added: Day ${dayCount}, Date: ${date.toISOString().split('T')[0]}`);
            }
        }
    }

    function toggleTripDate(element) {
        const dayContent = element.nextElementSibling;
        dayContent.classList.toggle('show');
    }

    function addLocation(button) {
        // 장소 추가 버튼을 누를 시 menu_wrap이 보이도록 설정
        document.getElementById('menu_wrap').style.display = 'block';

        selectedDateDiv = button.closest('.tripDate');

        // 여행 몇째 날인지 추출 (ex. 1, 2, ..)
        if (selectedDateDiv) {
            // Day 정보를 포함하는 span 요소 선택
            const dayCountSpan = selectedDateDiv.querySelector('.dayCountLabel');

            if (dayCountSpan) {
                // "Day 1"과 같은 텍스트를 가져옴
                const dayText = dayCountSpan.textContent.trim();

                // "Day 1"에서 숫자 부분만 추출
                const dayNum = dayText.replace('Day ', '');

                // selectedPlaces 객체에서 dayNum에 해당하는 배열이 없으면 초기화
                if (!selectedPlaces[dayNum]) {
                    selectedPlaces[dayNum] = [];
                }

                if (!markers[dayNum]) {
                    markers[dayNum] = [];
                }

                return dayNum; // 예: "1"
            } else {
                console.error('Day count span not found in selectedDateDiv.');
            }
        } else {
            console.error('selectedDateDiv is not set.');
        }
        return null;
    }

    // 창 닫기 버튼 클릭 시 #menu_wrap 숨기기
    document.getElementById('closeBtn').addEventListener('click', function() {
        $('#menu_wrap').hide();
    });

    document.getElementById('toggleButton').addEventListener('click', function() {
        const filterWrap = document.getElementById('filter_wrap');
        const toggleButton = document.getElementById('toggleButton');

        if (filterWrap.classList.contains('hidden')) {
            filterWrap.classList.remove('hidden');
            toggleButton.textContent = '접기';
        } else {
            filterWrap.classList.add('hidden');
            toggleButton.textContent = '열기';
        }
    });
</script>
<script type="text/javascript"
        src="//dapi.kakao.com/v2/maps/sdk.js?appkey=c60fdc23b01e5e1886e831583b4cefb0&libraries=services"></script>
<script src="/js/createtrip.js"></script>
</body>
</html>

