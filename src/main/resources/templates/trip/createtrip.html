<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>여행 일정 생성</title>
    <link rel="stylesheet" href="/css/trip.css">
    <link rel="stylesheet" href="/css/map.css">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
</head>
<body>
<div class="container">
    <!-- 여행 일정 생성 영역 -->
    <div class="form_wrap">
        <form id="tripForm">
            <h1>여행 일정 생성</h1>
            <label for="tripName">여행 이름</label>
            <input type="text" id="tripName" name="tripName" placeholder="여행 이름을 입력해주세요" required><br>

            <label for="startDate">여행 시작일</label>
            <input type="date" id="startDate" name="startDate" required onchange="updateTripDates()"><br>

            <label for="endDate">여행 종료일</label>
            <input type="date" id="endDate" name="endDate" required onchange="updateTripDates()"><br>

            <label for="regionSelect">지역 선택</label>
            <select id="regionSelect" onchange="updateCities()">
                <option value="">지역을 선택해주세요</option>
                <option value="특별시/광역시">특별시/광역시</option>
                <option value="강원도">강원도</option>
                <option value="경기도">경기도</option>
                <option value="경상남도">경상남도</option>
                <option value="경상북도">경상북도</option>
                <option value="충청남도">충청남도</option>
                <option value="충청북도">충청북도</option>
                <option value="전라남도">전라남도</option>
                <option value="전라북도">전라북도</option>
                <option value="제주특별자치도">제주도</option>
            </select><br>

            <label for="citySelect">도시 선택</label>
            <select id="citySelect" name="cityId" required>
                <option value="">도시를 선택해주세요</option>
            </select><br>
            <input type="hidden" id="cityId" name="cityId" required>

            <h2>세부 일정</h2>
            <div id="tripDates"></div>

            <button type="submit">일정 생성</button>
        </form>
    </div>

    <!-- 지도 영역 -->
    <div class="map_wrap">
        <div id="map"></div>

        <!-- 검색 메뉴 컨테이너 -->
        <div id="menu_wrap" class="bg_white">
            <div class="option">
                <div>
                    <!-- 검색 폼 제출 시 searchPlaces() 호출 -->
                    <form onsubmit="searchPlaces(); return false;">
                        <input type="text" value="부산 맛집" id="keyword" size="15">
                        <button type="submit" id="searchBtn">검색하기</button>
                    </form>
                    <button type="button" id="completeBtn">선택 완료</button>
                </div>
            </div>
            <hr>
            <!-- 장소 목록을 표시할 리스트 -->
            <ul id="placesList"></ul>
            <!-- 페이지네이션을 표시 -->
            <div id="pagination"></div>
        </div>
    </div>
</div>

<script>
    const regions = {
        "특별시/광역시": [
            "서울특별시",
            "부산광역시",
            "대구광역시",
            "인천광역시",
            "광주광역시",
            "대전광역시",
            "울산광역시",
            "세종특별자치시"
        ],
        "강원도": [
            "춘천시",
            "원주시",
            "강릉시",
            "동해시",
            "태백시",
            "속초시",
            "삼척시",
            "홍천군",
            "횡성군",
            "평창군",
            "정선군",
            "영월군"
        ],
        "경기도": [
            "수원시",
            "고양시",
            "용인시",
            "성남시",
            "부천시",
            "남양주시",
            "안산시",
            "안양시",
            "평택시",
            "의정부시",
            "군포시",
            "오산시",
            "시흥시",
            "하남시",
            "의왕시",
            "양주시",
            "파주시",
            "광명시",
            "구리시",
            "여주시"
        ],
        "경상남도": [
            "창원시",
            "김해시",
            "진주시",
            "양산시",
            "거제시",
            "통영시",
            "사천시",
            "밀양시",
            "함안군",
            "거창군",
            "창녕군",
            "산청군",
            "의령군",
            "고성군",
            "하동군",
            "합천군"
        ],
        "경상북도": [
            "포항시",
            "경주시",
            "구미시",
            "김천시",
            "안동시",
            "영주시",
            "상주시",
            "문경시",
            "경산시",
            "영천시",
            "청송군",
            "영양군",
            "봉화군",
            "울릉군",
            "예천군",
            "성주군",
            "군위군",
            "의성군"
        ],
        "충청남도": [
            "천안시",
            "아산시",
            "서산시",
            "논산시",
            "보령시",
            "계룡시",
            "당진시",
            "금산군",
            "부여군",
            "서천군",
            "홍성군",
            "예산군",
            "청양군",
            "태안군"
        ],
        "충청북도": [
            "청주시",
            "충주시",
            "제천시",
            "보은군",
            "옥천군",
            "영동군"
        ],
        "전라남도": [
            "여수시",
            "순천시",
            "목포시",
            "나주시",
            "광양시",
            "담양군",
            "곡성군",
            "구례군",
            "고흥군",
            "보성군",
            "장흥군",
            "강진군",
            "해남군",
            "완도군",
            "진도군",
            "신안군",
            "무안군",
            "영암군"
        ],
        "전라북도": [
            "전주시",
            "군산시",
            "익산시",
            "남원시",
            "정읍시",
            "김제시",
            "완주군",
            "진안군",
            "무주군",
            "장수군",
            "고창군",
            "임실군",
            "순창군"
        ],
        "제주특별자치도": [
            "제주시",
            "서귀포시"
        ]
    };

    function updateCities() {
        const regionSelect = document.getElementById('regionSelect');
        const citySelect = document.getElementById('citySelect');
        const selectedRegion = regionSelect.value;

        citySelect.innerHTML = '<option value="">도시를 선택하세요</option>';

        if (selectedRegion && regions[selectedRegion]) {
            regions[selectedRegion].forEach(cityName => {
                const option = document.createElement('option');
                option.value = cityName;
                option.textContent = cityName;
                citySelect.appendChild(option);
            });
        }
    }

    document.getElementById('citySelect').addEventListener('change', function () {
        const cityName = this.value;
        const encodedCityName = encodeURIComponent(cityName);

        fetch(`/api/cities/name/${encodedCityName}`)
            .then(response => response.json())
            .then(city => {
                if (city) {
                    document.getElementById('cityId').value = city.id;
                    console.log(`City selected: ${city.name} with id ${city.id}`);
                } else {
                    alert('City not found in database.');
                    console.error('City not found in database.');
                }
            })
            .catch(error => console.error('Error fetching city by name:', error));
    });

    document.getElementById('tripForm').addEventListener('submit', function (event) {
        event.preventDefault();

        const tripName = document.getElementById('tripName').value;
        const startDate = document.getElementById('startDate').value;
        const endDate = document.getElementById('endDate').value;
        const cityId = parseInt(document.getElementById('cityId').value, 10);

        const tripDates = [];
        document.querySelectorAll('.tripDate').forEach(function (tripDateElement) {
            const tripDate = tripDateElement.querySelector('input[name="tripDate"]').value;

            const tripLocations = [];
            tripDateElement.querySelectorAll('.locations').forEach(function (locationElement) {
                const placeName = locationElement.querySelector('input[name="placeName"]').value;
                const latitude = locationElement.querySelector('input[name="latitude"]').value;
                const longitude = locationElement.querySelector('input[name="longitude"]').value;

                tripLocations.push({ placeName, latitude, longitude });
                console.log(`Location added: ${placeName}, ${latitude}, ${longitude}`);
            });

            tripDates.push({ tripDate, tripLocations });
            console.log(`TripDate added: ${tripDate} with locations: ${JSON.stringify(tripLocations)}`);
        });

        const data = {
            tripName,
            startDate,
            endDate,
            cityId,
            tripDates
        };

        console.log('서버로 데이터 전송:', JSON.stringify(data));

        fetch('/api/trips', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(data)
        })
            .then(response => response.json().then(data => {
                if (!response.ok) {
                    throw new Error(data.error);
                }
                return data;
            }))
            .then(data => {
                alert(data.message);
                console.log('Success:', data);
                window.location.href = '/';
            })
            .catch(error => {
                alert(error.message);
                console.error('Error:', error);
            });
    });

    function updateTripDates() {
        const startDate = document.getElementById('startDate').value;
        const endDate = document.getElementById('endDate').value;

        // 시작 날짜와 종료 날짜가 모두 존재하는지 확인
        if (startDate && endDate) {
            const start = new Date(startDate);
            const end = new Date(endDate);
            const tripDates = document.getElementById('tripDates');
            tripDates.innerHTML = '';

            for (let date = new Date(start), dayCount = 1; date <= end; date.setDate(date.getDate() + 1), dayCount++) {
                const tripDateHtml = `
                    <div class="tripDate">
                        <div class="dayHeader" onclick="toggleTripDate(this)">
                            <span class="dayCountLabel">Day ${dayCount}</span>
                            <span> ${date.toISOString().split('T')[0]}</span>
                        </div>
                        <div class="dayContent">
<!--                            <label for="tripDate">날짜:</label>-->
                            <input type="hidden" name="tripDate" value="${date.toISOString().split('T')[0]}" required readonly><br>
                        </div>
                        <div class="dayLocation">
                        </div>
                        <button type="button" onclick="addLocation(this)">장소 추가</button>
                    </div>
                `;
                tripDates.insertAdjacentHTML('beforeend', tripDateHtml);
                console.log(`TripDate added: Day ${dayCount}, Date: ${date.toISOString().split('T')[0]}`);
            }
        }
    }

    function toggleTripDate(element) {
        const dayContent = element.nextElementSibling;
        dayContent.classList.toggle('show');
    }

    function addLocation(button) {

        selectedDateDiv = button.closest('.tripDate');

        // const locationHtml = `
        //     <div class="locations">
        //         <label for="placeName">장소 이름:</label>
        //         <input type="text" name="placeName" required><br>
        //         <label for="latitude">위도:</label>
        //         <input type="number" step="0.000001" name="latitude"><br>
        //         <label for="longitude">경도:</label>
        //         <input type="number" step="0.000001" name="longitude"><br>
        //     </div>
        // `;
        // button.insertAdjacentHTML('beforebegin', locationHtml);
        // console.log('Location added.');

        // 장소 추가 버튼을 누를 시 menu_wrap이 보이도록 설정
        document.getElementById('menu_wrap').style.display = 'block';
    }

    function handleSelectCompleteBtnClick() {
        if (selectedPlaces.length === 0) {
            alert('선택된 장소가 없습니다. 장소를 추가해 주세요.');
            return;
        }

        if (!selectedDateDiv) {
            alert('장소를 추가할 날짜를 선택해 주세요.');
            return;
        }

        const locationsContainer = selectedDateDiv.querySelector('.dayLocation');
        selectedPlaces.forEach(place => {
            const locations = document.createElement('div');
            locations.className = 'locations';

            locations.innerHTML = `
            <input type="text" name="placeName" value="${place.place_name}" readonly />
            <input type="hidden" name="longitude" value="${place.x}" />
            <input type="hidden" name="latitude" value="${place.y}" />
        `;
            locationsContainer.appendChild(locations);
        });

        selectedPlaces = [];
        selectedDateDiv = null;
        // 선택 완료 버튼 누를 시 검색창 숨기기
        $('#menu_wrap').hide();
    }

    // 선택 완료 버튼 클릭 이벤트
    document.getElementById('completeBtn').addEventListener('click', handleSelectCompleteBtnClick);
</script>
<script type="text/javascript"
        src="//dapi.kakao.com/v2/maps/sdk.js?appkey=c60fdc23b01e5e1886e831583b4cefb0&libraries=services"></script>
<script src="/js/map.js"></script>
</body>
</html>


