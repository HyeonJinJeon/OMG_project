<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>여행 일정 수정</title>
  <link rel="stylesheet" href="/css/createtrip.css">
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
    }
    h1 {
      color: #333;
    }
    form {
      border: 1px solid #ccc;
      padding: 20px;
      border-radius: 5px;
    }
    label {
      display: block;
      margin: 10px 0 5px;
    }
    input[type="text"], input[type="date"], button {
      width: 100%;
      padding: 8px;
      margin-bottom: 10px;
    }
    input[type="date"]:disabled {
      background-color: #e9e9e9;
    }
    .trip-date, .trip-location {
      margin-bottom: 20px;
      border: 1px solid #ccc;
      padding: 10px;
      border-radius: 5px;
    }
    .trip-date-title {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
  </style>
</head>
<body>
<h1>여행 일정 수정</h1>
<form id="tripForm">
  <label for="tripName">여행 이름:</label>
  <input type="text" id="tripName" name="tripName">

  <label for="startDate">시작 날짜:</label>
  <input type="date" id="startDate" name="startDate" disabled>

  <label for="endDate">종료 날짜:</label>
  <input type="date" id="endDate" name="endDate" disabled>

  <div id="tripDatesContainer">
    <!-- 여행 날짜 및 장소들이 동적으로 추가될 부분 -->
  </div>

  <button type="button" onclick="addTripDate()">여행 날짜 추가</button>
  <button type="submit">저장</button>
</form>

<script>
  let tripDatesCounter = 0;

  document.getElementById('tripForm').addEventListener('submit', function (event) {
    event.preventDefault();
    const trip = {
      tripName: document.getElementById('tripName').value,
      startDate: document.getElementById('startDate').value,
      endDate: document.getElementById('endDate').value,
      tripDates: []
    };

    document.querySelectorAll('.trip-date').forEach(dateElement => {
      const tripDate = {
        id: dateElement.dataset.id || null,
        tripDate: dateElement.querySelector('.tripDateInput').value,
        tripLocations: []
      };

      dateElement.querySelectorAll('.trip-location').forEach(locationElement => {
        const tripLocation = {
          id: locationElement.dataset.id || null,
          placeName: locationElement.querySelector('.placeNameInput').value,
          latitude: parseFloat(locationElement.querySelector('.latitudeInput').value),
          longitude: parseFloat(locationElement.querySelector('.longitudeInput').value)
        };
        tripDate.tripLocations.push(tripLocation);
      });

      trip.tripDates.push(tripDate);
    });

    fetch(`/api/trips/${tripId}`, {
      method: 'PUT',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify(trip)
    }).then(response => {
      if (response.ok) {
        alert('여행 일정이 성공적으로 수정되었습니다.');
        window.location.href = `/viewtripdetails/${tripId}`;
      } else {
        alert('여행 일정 수정 중 오류가 발생했습니다.');
      }
    });
  });

  function addTripDate(tripDateData = {}) {
    const tripDateId = tripDatesCounter++;
    const tripDateElement = document.createElement('div');
    tripDateElement.className = 'trip-date';
    tripDateElement.dataset.id = tripDateData.id || '';

    tripDateElement.innerHTML = `
            <div class="trip-date-title">
                <input type="date" class="tripDateInput" value="${tripDateData.tripDate || ''}" disabled>
                <span class="dayLabel"> ${tripDateId + 1}일째</span>
                <button type="button" onclick="removeElement(this.parentNode.parentNode)">삭제</button>
            </div>
            <div class="trip-locations">
                ${tripDateData.tripLocations ? tripDateData.tripLocations.map(loc => createTripLocationHtml(loc)).join('') : ''}
            </div>
            <button type="button" onclick="addTripLocation(this.parentNode)">장소 추가</button>
        `;

    document.getElementById('tripDatesContainer').appendChild(tripDateElement);
  }

  function addTripLocation(tripDateElement, tripLocationData = {}) {
    const tripLocationElement = document.createElement('div');
    tripLocationElement.className = 'trip-location';
    tripLocationElement.dataset.id = tripLocationData.id || '';

    tripLocationElement.innerHTML = `
            <input type="text" class="placeNameInput" placeholder="장소 이름" value="${tripLocationData.placeName || ''}">
            <input type="text" class="latitudeInput" placeholder="위도" value="${tripLocationData.latitude || ''}">
            <input type="text" class="longitudeInput" placeholder="경도" value="${tripLocationData.longitude || ''}">
            <button type="button" onclick="removeElement(this.parentNode)">삭제</button>
        `;

    tripDateElement.querySelector('.trip-locations').appendChild(tripLocationElement);
  }

  function removeElement(element) {
    element.parentNode.removeChild(element);
    updateDayCount();
  }

  function createTripLocationHtml(tripLocationData) {
    return `
            <div class="trip-location" data-id="${tripLocationData.id || ''}">
                <input type="text" class="placeNameInput" placeholder="장소 이름" value="${tripLocationData.placeName || ''}">
                <input type="text" class="latitudeInput" placeholder="위도" value="${tripLocationData.latitude || ''}">
                <input type="text" class="longitudeInput" placeholder="경도" value="${tripLocationData.longitude || ''}">
                <button type="button" onclick="removeElement(this.parentNode)">삭제</button>
            </div>
        `;
  }

  function fetchTripData() {
    fetch(`/api/trips/${tripId}`)
            .then(response => response.json())
            .then(trip => {
              document.getElementById('tripName').value = trip.tripName;
              document.getElementById('startDate').value = trip.startDate;
              document.getElementById('endDate').value = trip.endDate;

              trip.tripDates.forEach(tripDate => addTripDate(tripDate));
            });
  }

  function updateDayCount() {
    const tripDateInputs = document.querySelectorAll('.tripDateInput');
    tripDateInputs.forEach((input, index) => {
      const dayLabel = input.parentNode.querySelector('.dayLabel');
      if (dayLabel) {
        dayLabel.remove();
      }
      const newDayLabel = document.createElement('span');
      newDayLabel.className = 'dayLabel';
      newDayLabel.textContent = ` ${index + 1}일째`;
      input.parentNode.insertBefore(newDayLabel, input.nextSibling);
    });
  }

  // 페이지 로드 시 여행 데이터를 가져옴
  const tripId = window.location.pathname.split('/').pop();
  fetchTripData();
</script>
</body>
</html>
