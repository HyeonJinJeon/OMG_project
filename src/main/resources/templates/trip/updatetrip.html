<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>여행 일정 수정</title>
    <link rel="stylesheet" href="/css/trip.css">
    <link rel="stylesheet" href="/css/map.css">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
</head>
<body>
<div class="container">
    <div class="form_wrap">
        <form id="tripForm">
            <h1>여행 일정 수정</h1>
            <label for="tripName">여행 이름:</label>
            <input type="text" id="tripName" name="tripName">

            <label for="startDate">시작 날짜:</label>
            <input type="date" id="startDate" name="startDate" disabled>

            <label for="endDate">종료 날짜:</label>
            <input type="date" id="endDate" name="endDate" disabled>

            <div id="tripDatesContainer">
                <!-- 여행 날짜 및 장소들이 동적으로 추가될 부분 -->
            </div>
            <button id="editButton">수정</button>
        </form>
    </div>
    <div class="map_wrap">
        <!--        <div id="map" style="width:70%;height:100%;position:relative;overflow:hidden;"></div>-->
        <div id="map"></div>

        <!-- 검색 메뉴 컨테이너 -->
        <div id="menu_wrap" class="bg_white">
            <div class="option">
                <div>
                    <!-- 검색 폼 제출 시 searchPlaces() 호출 -->
                    <form onsubmit="searchPlaces(); return false;">
                        키워드 : <input type="text" value="부산 맛집" id="keyword" size="15">
                        <button type="submit" id="searchBtn">검색하기</button>
                    </form>
                </div>
            </div>
            <div>
                <button type="button" id="completeBtn">선택 완료</button>
            </div>
            <hr>
            <!-- 장소 목록을 표시할 리스트 -->
            <ul id="placesList"></ul>
            <!-- 페이지네이션을 표시 -->
            <div id="pagination"></div>
        </div>
    </div>
</div>

<script>
    let tripDatesCounter = 0;

    document.getElementById('tripForm').addEventListener('submit', function (event) {
        event.preventDefault();
        const trip = {
            tripName: document.getElementById('tripName').value,
            startDate: document.getElementById('startDate').value,
            endDate: document.getElementById('endDate').value,
            tripDates: []
        };

        document.querySelectorAll('.trip-date').forEach(dateElement => {
            const tripDate = {
                id: dateElement.dataset.id || null,
                tripDate: dateElement.querySelector('.tripDateInput').value,
                tripLocations: []
            };

            dateElement.querySelectorAll('.trip-location').forEach(locationElement => {
                const tripLocation = {
                    id: locationElement.dataset.id || null,
                    placeName: locationElement.querySelector('.placeNameInput').value,
                    latitude: parseFloat(locationElement.querySelector('.latitudeInput').value),
                    longitude: parseFloat(locationElement.querySelector('.longitudeInput').value)
                };
                tripDate.tripLocations.push(tripLocation);
            });

            trip.tripDates.push(tripDate);
        });

        fetch(`/api/trips/${tripId}`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(trip)
        }).then(response => {
            if (response.ok) {
                alert('여행 일정이 성공적으로 수정되었습니다.');
                window.location.href = '/';
            } else {
                alert('여행 일정 수정 중 오류가 발생했습니다.');
            }
        });
    });

    function addTripDate(tripDateData = {}) {
        const tripDateId = tripDatesCounter++;
        const tripDateElement = document.createElement('div');
        tripDateElement.className = 'trip-date';
        tripDateElement.dataset.id = tripDateData.id || '';

        tripDateElement.innerHTML = `
        <div class="trip-date-title">
          <input type="date" class="tripDateInput" value="${tripDateData.tripDate || ''}" disabled>
        </div>
        <div class="trip-locations">
          ${tripDateData.tripLocations ? tripDateData.tripLocations.map(loc => createTripLocationHtml(loc)).join('') : ''}
        </div>
        <button type="button" onclick="addTripLocation(this.parentNode)">장소 추가</button>
      `;

        document.getElementById('tripDatesContainer').appendChild(tripDateElement);
    }

    function addTripLocation(tripDateElement, tripLocationData = {}) {
        // 현재 선택된 날짜 div
        selectedDateDiv = tripDateElement;

        document.getElementById('menu_wrap').style.display = 'block';
        //
        // const tripLocationElement = document.createElement('div');
        // tripLocationElement.className = 'trip-location';
        // tripLocationElement.dataset.id = tripLocationData.id || '';

      //   tripLocationElement.innerHTML = `
      //   <input type="text" class="placeNameInput" placeholder="장소 이름" value="${tripLocationData.placeName || ''}">
      //   <input type="text" class="latitudeInput" placeholder="위도" value="${tripLocationData.latitude || ''}">
      //   <input type="text" class="longitudeInput" placeholder="경도" value="${tripLocationData.longitude || ''}">
      //   <button type="button" onclick="removeElement(this.parentNode)">삭제</button>
      // `;
      //   tripLocationElement.innerHTML = ``;
      //
      //   tripDateElement.querySelector('.trip-locations').appendChild(tripLocationElement);
    }

    function handleSelectCompleteBtnClick() {
        if (selectedPlaces.length === 0) {
            alert('선택된 장소가 없습니다. 장소를 추가해 주세요.');
            return;
        }

        if (!selectedDateDiv) {
            alert('장소를 추가할 날짜를 선택해 주세요.');
            return;
        }

        const locationsContainer = selectedDateDiv.querySelector('.trip-locations');
        selectedPlaces.forEach(place => {
            const tripLocationElement = document.createElement('div');
            tripLocationElement.className = 'trip-location';
            tripLocationElement.dataset.id = place.id || '';
            // tripLocationElement.dataset.id = tripLocationData.id || '';
            // const locations = document.createElement('div');
            // locations.className = 'trip-location';
            // locations.dataset.id = place.id || '';

            // 위도와 경도를 소수점 6자리까지 포맷
            const formattedLatitude = parseFloat(place.y).toFixed(6);
            const formattedLongitude = parseFloat(place.x).toFixed(6);

            // locations.innerHTML = `
            tripLocationElement.innerHTML = `
            <input type="text" class="placeNameInput" value="${place.place_name}" readonly />
            <input type="text" class="longitudeInput" value="${formattedLongitude}" />
            <input type="text" class="latitudeInput" value="${formattedLatitude}" />
            <button type="button" onclick="removeElement(this.parentNode)">삭제</button>
        `;

            locationsContainer.appendChild(tripLocationElement);
            // locationsContainer.appendChild(locations);
        });

        selectedPlaces = [];
        selectedDateDiv = null;
        // 선택 완료 버튼 누를 시 검색창 숨기기
        $('#menu_wrap').hide();
    }

    function removeElement(element) {
        // element는 trip-location div
        const locationId = element.dataset.id;

        // 화면에서 요소 제거
        element.parentNode.removeChild(element);

        updateDayCount();
    }

    function createTripLocationHtml(tripLocationData) {
        return `
        <div class="trip-location" data-id="${tripLocationData.id || ''}">
          <input type="text" class="placeNameInput" placeholder="장소 이름" value="${tripLocationData.placeName || ''}">
          <input type="text" class="latitudeInput" placeholder="위도" value="${tripLocationData.latitude || ''}">
          <input type="text" class="longitudeInput" placeholder="경도" value="${tripLocationData.longitude || ''}">
          <button type="button" onclick="removeElement(this.parentNode)">삭제</button>
        </div>
      `;
    }

    function fetchTripData() {
        fetch(`/api/trips/${tripId}`)
            .then(response => response.json())
            .then(trip => {
                document.getElementById('tripName').value = trip.tripName;
                document.getElementById('startDate').value = trip.startDate;
                document.getElementById('endDate').value = trip.endDate;

                trip.tripDates.forEach(tripDate => addTripDate(tripDate));
            });
    }

    function updateDayCount() {
        const tripDateInputs = document.querySelectorAll('.tripDateInput');
        tripDateInputs.forEach((input, index) => {
            const dayLabel = input.parentNode.querySelector('.dayLabel');
            if (dayLabel) {
                dayLabel.remove();
            }
            const newDayLabel = document.createElement('span');
            newDayLabel.className = 'dayLabel';
            newDayLabel.textContent = `${index + 1}일째`;
            input.parentNode.insertBefore(newDayLabel, input.nextSibling);
        });
    }

    // 페이지 로드 시 여행 데이터를 가져옴
    const tripId = window.location.pathname.split('/').pop();
    fetchTripData();

    document.getElementById('editButton').addEventListener('click', function () {
        window.location.href = `/trip/update/${tripId}`;
    });

    // 선택 완료 버튼 클릭 이벤트
    document.getElementById('completeBtn').addEventListener('click', handleSelectCompleteBtnClick);
</script>
<script type="text/javascript"
        src="//dapi.kakao.com/v2/maps/sdk.js?appkey=c60fdc23b01e5e1886e831583b4cefb0&libraries=services"></script>
<script src="/js/map.js"></script>
</body>
</html>
