<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>여행 일정 수정</title>
    <link rel="stylesheet" href="/css/trip.css">
    <link rel="stylesheet" href="/css/map.css">
    <link rel="stylesheet" href="/css/recommend.css">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
</head>
<body>
<div class="container">
    <!-- 여행 일정 생성 영역 -->
    <div class="form_wrap">
        <a href="/" class="backLink">↩️ 메인 화면</a>
        <form id="tripForm">
            <h1>여행 일정 수정</h1>
            <label for="tripName">여행 이름</label>
            <input type="text" id="tripName" name="tripName">

            <!-- 도시 이름을 표시할 요소 추가 -->
            <input type="hidden" id="cityId" name="cityId" required>
            <div id="cityName" style="display: none;"></div> <!-- CSS로 숨기기 -->

            <label for="startDate">여행 시작일</label>
            <input type="date" id="startDate" name="startDate">

            <label for="endDate">여행 종료일</label>
            <input type="date" id="endDate" name="endDate">

            <h2>세부 일정</h2>
            <div id="tripDatesContainer">
                <!-- 여행 날짜 및 장소들이 동적으로 추가될 부분 -->
            </div>
            <button type="submit" id="editButton">수정</button>
        </form>
    </div>

    <!-- 지도 영역 -->
    <div class="map_wrap">
        <div id="map"></div>

        <!-- 검색 메뉴 컨테이너 -->
        <div id="menu_wrap" class="bg_white">
            <div class="option">
                <div>
                    <!-- 검색 폼 제출 시 searchPlaces() 호출 -->
                    <form onsubmit="searchPlaces(); return false;">
                        <input type="text" placeholder="장소명을 입력해주세요." id="keyword" size="15">
                        <button type="submit" id="searchBtn">검색하기</button>
                    </form>
                    <button type="button" id="closeBtn">창 닫기</button>
                </div>
            </div>
            <hr>
            <!-- 장소 목록을 표시할 리스트 -->
            <ul id="placesList"></ul>
            <!-- 페이지네이션을 표시 -->
            <div id="pagination"></div>
        </div>
        <button id="toggleButton" class="toggleButton">접기</button> <!-- 접기/펼치기 버튼을 창 밖으로 이동 -->
        <div class="filter_wrap" id="filter_wrap">
            <h3 id="filterTitle">여행 명소 추천</h3> <!-- 제목 추가 -->
            <div id="filterContent">
                <div id="filterButtons">
                    <button type="button" onclick="filterPlaces(12)">관광지</button>
                    <button type="button" onclick="filterPlaces(39)">식당</button>
                    <button type="button" onclick="filterPlaces(32)">숙박</button>
                    <button type="button" onclick="filterPlaces(14)">문화시설</button>
                    <button type="button" onclick="filterPlaces(15)">축제/행사</button>
                    <button type="button" onclick="filterPlaces(28)">레포츠</button>
                    <button type="button" onclick="filterPlaces(38)">쇼핑</button>
                </div>
                <br>
                <hr>
                <div id="filteredPlacesListContainer">
                    <ul id="filteredPlacesList"></ul>
                </div>
            </div>
        </div>
    </div>
</div>


<script>
    let tripDatesCounter = 0;
    let markers = {};
    let selectedPlaces = {};
    let selectedDateDiv = null;

    // 수정 버튼 클릭 이벤트 핸들러
    document.getElementById('editButton').addEventListener('click', function(event) {
        event.preventDefault(); // 폼의 기본 제출 동작 방지

        const tripId = window.location.pathname.split('/').pop(); // URL에서 tripId 추출
        console.log('Extracted tripId:', tripId);

        // 여행 일정 데이터를 폼에서 가져오기
        const trip = {
            tripName: document.getElementById('tripName').value,
            startDate: document.getElementById('startDate').value,
            endDate: document.getElementById('endDate').value,
            cityId: document.getElementById('cityId').value,
            tripDates: [] // tripDates 데이터는 필요에 따라 추가
        };

        document.querySelectorAll('.trip-date').forEach(dateElement => {
            const tripDate = {
                id: dateElement.dataset.id || null,
                tripDate: dateElement.querySelector('.tripDateInput').value,
                tripLocations: []
            };

            dateElement.querySelectorAll('.trip-location').forEach(locationElement => {
                const tripLocation = {
                    id: locationElement.dataset.id || null,
                    placeName: locationElement.querySelector('.placeNameInput').value,
                    latitude: parseFloat(locationElement.querySelector('.latitudeInput').value),
                    longitude: parseFloat(locationElement.querySelector('.longitudeInput').value)
                };
                tripDate.tripLocations.push(tripLocation);
            });

            trip.tripDates.push(tripDate);
        });

        fetch(`/api/trips/${tripId}`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(trip)
        }).then(response => {
            if (response.ok) {
                alert('여행 일정이 성공적으로 수정되었습니다.');
                window.location.href = `/trip/update/${tripId}`;
            } else {
                alert('여행 일정 수정 중 오류가 발생했습니다.');
            }
        });
    });

    function addTripDate(tripDateData = {}) {
        const tripDateId = tripDatesCounter++;
        const tripDateElement = document.createElement('div');
        tripDateElement.className = 'trip-date';
        tripDateElement.dataset.id = tripDateData.id || '';

        tripDateElement.innerHTML = `
        <div class="trip-date-title">
          <span class="dayCountLabel">Day ${tripDateId + 1}</span>
          <span> ${tripDateData.tripDate || ''}</span>
          <input type="hidden" class="tripDateInput" value="${tripDateData.tripDate || ''}" disabled>
        </div>
        <div class="trip-locations">
          ${tripDateData.tripLocations ? tripDateData.tripLocations.map((loc, index) => createTripLocationHtml(loc, tripDateId + 1, index + 1)).join('') : ''}
        </div>
        <button type="button" onclick="addTripLocation(this)">장소 추가</button>
      `;

        document.getElementById('tripDatesContainer').appendChild(tripDateElement);

        const dayNum = tripDateId + 1;
        if (tripDateData.tripLocations) {
            selectedPlaces[dayNum] = tripDateData.tripLocations.map(loc => ({
                placeName: loc.placeName,
                latitude: loc.latitude,
                longitude: loc.longitude
            }));

            markers[dayNum] = [];
            tripDateData.tripLocations.forEach((loc) => {
                addSavedPlacesMarker(loc.latitude, loc.longitude, markers[dayNum].length, dayNum);
                // 폴리라인 그리기
                drawLinePath(dayNum, new kakao.maps.LatLng(loc.latitude, loc.longitude));
            });

        } else {
            selectedPlaces[dayNum] = [];
            markers[dayNum] = [];
        }
    }

    function addTripLocation(button) {
        document.getElementById('menu_wrap').style.display = 'block';

        selectedDateDiv = button.closest('.trip-date');

        if (selectedDateDiv) {
            const dayCountSpan = selectedDateDiv.querySelector('.dayCountLabel');

            if (dayCountSpan) {
                const dayText = dayCountSpan.textContent.trim();
                const dayNum = dayText.replace('Day ', '');
                reorderLocations();

                if (!selectedPlaces[dayNum]) {
                    selectedPlaces[dayNum] = [];
                }

                if (!markers[dayNum]) {
                    markers[dayNum] = [];
                }

                return dayNum;
            } else {
                console.error('Day count span not found in selectedDateDiv.');
            }
        } else {
            console.error('selectedDateDiv is not set.');
        }
        return null;
    }

    function handleSelectCompleteBtnClick() {
        if (selectedPlaces.length === 0) {
            alert('선택된 장소가 없습니다. 장소를 추가해 주세요.');
            return;
        }

        if (!selectedDateDiv) {
            alert('장소를 추가할 날짜를 선택해 주세요.');
            return;
        }

        const locationsContainer = selectedDateDiv.querySelector('.trip-locations');
        selectedPlaces.forEach((place, index) => {
            const tripLocationElement = document.createElement('div');
            tripLocationElement.className = 'trip-location';
            tripLocationElement.dataset.id = place.id || '';

            const formattedLatitude = parseFloat(place.y).toFixed(6);
            const formattedLongitude = parseFloat(place.x).toFixed(6);

            tripLocationElement.innerHTML = `
            <div class="placeNameContainer">
                <span id="${uniqueId}" style="color: ${getColorCode(index)};">${index + 1}</span>
                <input type="text" class="placeNameInput" value="${place.place_name}" readonly />
            </div>
            <input type="hidden" class="longitudeInput" value="${formattedLongitude}" />
            <input type="hidden" class="latitudeInput" value="${formattedLatitude}" />
        `;

            locationsContainer.appendChild(tripLocationElement);
            reorderLocations();
        });

        selectedPlaces = [];
        selectedDateDiv = null;
        $('#menu_wrap').hide();

    }

    function createTripLocationHtml(tripLocationData, dayNum, placeIndex) {
        const uniqueId = `${dayNum}-${placeIndex}`;
        const markerImageIndex = (dayNum % 6) === 0 ? 6 : (dayNum % 6);
        const colorCode = getColorCode(markerImageIndex);

        return `
    <div class="trip-location" data-id="${tripLocationData.id || ''}">
      <div class="placeNameContainer">
        <span class="placeNumber" id="${uniqueId}" style="color: ${colorCode};">${placeIndex}</span>
        <input type="text" class="placeNameInput" placeholder="장소 이름" value="${tripLocationData.placeName || ''}">
        <button type="button" onclick="handleRemoveBtnClick(event, '${uniqueId}', ${tripLocationData.longitude}, ${tripLocationData.latitude})">삭제</button>
      </div>
      <input type="hidden" class="latitudeInput" placeholder="위도" value="${tripLocationData.latitude || ''}">
      <input type="hidden" class="longitudeInput" placeholder="경도" value="${tripLocationData.longitude || ''}">
    </div>
  `;
    }


    function fetchTripData() {
        fetch(`/api/trips/${tripId}`)
            .then(response => response.json())
            .then(trip => {
                document.getElementById('tripName').value = trip.tripName;
                document.getElementById('startDate').value = trip.startDate;
                document.getElementById('endDate').value = trip.endDate;

                trip.tripDates.forEach(tripDate => addTripDate(tripDate));
                reorderLocations();
            });
    }

    function reorderLocations() {
        // 각 날짜의 .trip-date 요소를 순회
        document.querySelectorAll('.trip-date').forEach((dateElement) => {
            let locationCounter = 1; // 각 날짜의 장소 번호를 1부터 시작
            // 해당 날짜의 모든 .trip-location 요소를 순회하며 번호를 재정렬
            dateElement.querySelectorAll('.trip-location').forEach((locationElement) => {
                const placeNumberElement = locationElement.querySelector('span');
                if (placeNumberElement) {
                    placeNumberElement.textContent = locationCounter++; // 번호 갱신
                } else {
                    // 만약 'span' 요소가 없다면 새로 생성해서 추가
                    const newPlaceNumberElement = document.createElement('span');
                    newPlaceNumberElement.textContent = locationCounter++;
                    locationElement.insertBefore(newPlaceNumberElement, locationElement.firstChild);
                }
            });
        });
    }

    function updateDayCount() {
        const tripDateInputs = document.querySelectorAll('.tripDateInput');
        tripDateInputs.forEach((input, index) => {
            const dayCountLabel = input.parentNode.querySelector('.dayCountLabel');
            if (dayCountLabel) {
                dayCountLabel.textContent = `Day ${index + 1}`;
            } else {
                const newDayCountLabel = document.createElement('span');
                newDayCountLabel.className = 'dayCountLabel';
                newDayCountLabel.textContent = `Day ${index + 1}`;
                input.parentNode.insertBefore(newDayCountLabel, input);
            }
        });
    }

    const tripId = window.location.pathname.split('/').pop();
    fetchTripData();

    document.getElementById('closeBtn').addEventListener('click', function() {
        $('#menu_wrap').hide();
    });

    function updateTripDates() {
        const startDate = new Date(document.getElementById('startDate').value);
        const endDate = new Date(document.getElementById('endDate').value);

        if (isNaN(startDate) || isNaN(endDate) || startDate > endDate) {
            alert('유효한 날짜 범위를 선택하세요.');
            return;
        }

        const existingTripDates = document.querySelectorAll('.trip-date');
        const existingTripData = Array.from(existingTripDates).map((dateElement, index) => {
            const tripLocations = Array.from(dateElement.querySelectorAll('.trip-location')).map(locationElement => ({
                placeName: locationElement.querySelector('.placeNameInput').value,
                latitude: parseFloat(locationElement.querySelector('.latitudeInput').value),
                longitude: parseFloat(locationElement.querySelector('.longitudeInput').value)
            }));

            return {
                tripDate: dateElement.querySelector('.tripDateInput').value,
                tripLocations
            };
        });

        const newTripDatesContainer = document.getElementById('tripDatesContainer');
        newTripDatesContainer.innerHTML = '';

        let newDateIndex = 0;
        for (let date = new Date(startDate); date <= endDate; date.setDate(date.getDate() + 1)) {
            const tripDateData = existingTripData[newDateIndex] || {};
            const dayNum = newDateIndex + 1;

            addTripDate({
                tripDate: date.toISOString().split('T')[0],
                tripLocations: tripDateData.tripLocations || []
            });

            newDateIndex++;
        }

        if (newDateIndex < existingTripData.length) {
            const lastTripLocations = existingTripData.slice(newDateIndex).flatMap(data => data.tripLocations);
            const lastDayElement = newTripDatesContainer.querySelector('.trip-date:last-child .trip-locations');
            lastTripLocations.forEach((loc, index) => {
                lastDayElement.insertAdjacentHTML('beforeend', createTripLocationHtml(loc, newDateIndex + 1, index + 1));
            });
        }

        updateDayCount();
        reorderLocations();
    }

    document.getElementById('startDate').addEventListener('change', updateTripDates);
    document.getElementById('endDate').addEventListener('change', updateTripDates);

    //도시 관련 데이터 추출
    document.addEventListener('DOMContentLoaded', function() {
        const tripId = window.location.pathname.split('/').pop(); // URL에서 tripId 추출

        fetch(`/api/trips/${tripId}`)
            .then(response => response.json())
            .then(data => {
                console.log('Received data:', data);
                if (data) {

                    // 도시 ID를 정확히 추출하여 표시
                    if (data.city && data.city.id !== undefined && data.city.name) {
                        document.getElementById('cityId').textContent = `도시 ID: ${data.city.id}`;
                        document.getElementById('cityName').textContent = `도시 이름: ${data.city.name}`;
                    } else {
                        document.getElementById('cityId').textContent = '도시 ID: 데이터 없음';
                        document.getElementById('cityName').textContent = '도시 이름: 데이터 없음';
                    }
                    filterPlaces(12);
                } else {
                    alert('여행 일정 정보를 가져오는 중 오류가 발생했습니다.');
                }
            })
            .catch(error => {
                console.error('Error fetching trip data:', error);
                alert('여행 일정 정보를 가져오는 중 오류가 발생했습니다.');
            });
    });

    function filterPlaces(contentTypeId) {
        const cityNameElement = document.getElementById('cityName');

        // 도시 이름 추출
        const cityName = cityNameElement ? cityNameElement.textContent.replace('도시 이름: ', '').trim() : '';

        if (!cityName) {
            alert('도시 이름을 확인할 수 없습니다.');
            return;
        }

        // 기본 설정
        const serviceKey = "bR6YX%2Fkp0Y%2Bvm31sUAayaUZjxmI7dVH0PTsTtlb90Ae9abKUTxIFBc7X4u1wnHnDUuk8uYekiXhdYgb5iyiw5w%3D%3D";
        const numOfRows = 100;  // 한 페이지에 표시할 결과 수
        const pageNo = 1;  // 페이지 번호
        const MobileOS = "WIN";  // 운영체제 정보
        const MobileApp = "OMG";  // 애플리케이션 이름

        // API 호출 URL 구성
        const apiUrl = `https://api.visitkorea.or.kr/openapi/service/rest/KorService/searchKeyword?serviceKey=${serviceKey}&MobileOS=${MobileOS}&MobileApp=${MobileApp}&_type=json&listYN=Y&arrange=D&keyword=${encodeURIComponent(cityName)}&contentTypeId=${contentTypeId}&numOfRows=${numOfRows}&pageNo=${pageNo}`;

        // API 호출 URL을 콘솔에 출력
        console.log('API 호출 URL:', apiUrl);

        // API 호출
        fetch(apiUrl)
            .then(response => response.json())
            .then(data => {
                console.log('API 응답 데이터:', data);
                if (data.response && data.response.body && data.response.body.items) {
                    displayFilteredPlaces(data.response.body.items.item);
                } else {
                    alert('검색 결과가 없습니다.');
                }
            })
            .catch(error => {
                console.error('Error fetching data:', error);
                alert('데이터를 불러오는데 실패했습니다.');
            });
    }
    function displayFilteredPlaces(places) {
        const listEl = document.getElementById('filteredPlacesList');
        listEl.innerHTML = '';

        if (!places || places.length === 0) {
            listEl.innerHTML = '<li>검색 결과가 없습니다.</li>';
            return;
        }

        places.forEach(place => {
            const imageUrl = place.firstimage || 'https://via.placeholder.com/100';  // 기본 이미지 사용
            const phone = place.tel || 'x';
            const address1 = place.addr1 || 'x';

            const itemEl = document.createElement('li');
            itemEl.innerHTML = `
            <img src="${imageUrl}" alt="${place.title}">
            <div class="place-info">
                <h3>${place.title}</h3>
                <p><strong>전화번호:</strong> ${phone}</p>
                <p><strong>주소:</strong> ${address1}</p>
            </div>
            `;
            listEl.appendChild(itemEl);
        });
    }

    document.getElementById('toggleButton').addEventListener('click', function() {
        const filterWrap = document.getElementById('filter_wrap');
        const toggleButton = document.getElementById('toggleButton');

        if (filterWrap.classList.contains('hidden')) {
            filterWrap.classList.remove('hidden');
            toggleButton.textContent = '접기';
        } else {
            filterWrap.classList.add('hidden');
            toggleButton.textContent = '열기';
        }
    });


</script>
<script type="text/javascript"
        src="//dapi.kakao.com/v2/maps/sdk.js?appkey=c60fdc23b01e5e1886e831583b4cefb0&libraries=services"></script>
<script src="/js/updatetrip.js"></script>
</body>
</html>
