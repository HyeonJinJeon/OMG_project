<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>여행 일정 수정</title>
  <link rel="stylesheet" href="/css/updatetrip.css">
  <style>
    body {
      display: flex;
      font-family: Arial, sans-serif;
      background-color: #f0f0f0;
      margin: 0;
      padding: 0;
    }

    form {
      width: 35%;
      padding: 20px;
      background-color: #fff;
      border-right: 1px solid #ddd;
    }

    h1 {
      text-align: center;
      margin-bottom: 20px;
    }

    label {
      display: block;
      margin-top: 10px;
      margin-bottom: 5px;
      font-weight: bold;
    }

    input[type="text"],
    input[type="date"],
    textarea {
      width: 100%;
      padding: 10px;
      margin-bottom: 10px;
      border: 1px solid #ccc;
      border-radius: 5px;
      box-sizing: border-box;
      font-size: 16px;
    }

    input[type="text"]::placeholder {
      color: #aaa;
    }

    .region-container {
      position: relative;
      margin-bottom: 10px;
    }

    .cityListContainer {
      display: none;
      position: absolute;
      top: 100%;
      left: 0;
      background-color: #fff;
      border: 1px solid #ddd;
      border-radius: 5px;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      z-index: 10;
      width: 100%;
    }

    .region-list, .city-list {
      list-style-type: none;
      padding: 0;
      margin: 0;
    }

    .region-list li, .city-list li {
      cursor: pointer;
      padding: 10px;
      border: 1px solid #ddd;
      margin-bottom: 5px;
      border-radius: 5px;
    }

    .region-list li {
      background-color: #e0e0e0;
      color: #333;
    }

    .city-list li {
      background-color: #fff;
      color: #007bff;
    }

    .region-list li:hover, .city-list li:hover {
      background-color: #ddd;
    }

    .selected {
      font-weight: bold;
      color: blue;
    }

    .tripDate {
      margin-bottom: 20px;
      padding: 10px;
      border: 1px solid #ccc;
      border-radius: 5px;
      background-color: #fff;
    }

    .locations {
      margin-bottom: 10px;
    }

    button[type="submit"] {
      display: block;
      width: 100%;
      padding: 10px;
      background-color: #007bff;
      color: #fff;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-size: 16px;
    }

    button[type="submit"]:hover {
      background-color: #0056b3;
    }

    #map {
      width: 65%;
      height: 100vh;
    }

    .dayHeader {
      cursor: pointer;
      padding: 10px;
      border-radius: 5px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 18px;
      background-color: #fff;
    }

    .dayContent {
      display: none;
      padding: 10px;
      border-top: 1px solid #ccc;
    }

    .dayContent.show {
      display: block;
    }
  </style>
</head>
<body>
<form id="tripForm">
  <h1>여행 일정 수정</h1>
  <label for="tripName">여행 이름:</label>
  <input type="text" id="tripName" name="tripName" placeholder="여행 이름을 입력하세요">

  <label for="startDate">시작 날짜:</label>
  <input type="date" id="startDate" name="startDate" disabled>

  <label for="endDate">종료 날짜:</label>
  <input type="date" id="endDate" name="endDate" disabled>

  <div id="tripDatesContainer">
    <!-- 여행 날짜 및 장소들이 동적으로 추가될 부분 -->
  </div>

  <button type="button" onclick="addTripDate()">여행 날짜 추가</button>
  <button type="submit">저장</button>
</form>

<div id="map"></div>

<script>
  let tripDatesCounter = 0;

  document.getElementById('tripForm').addEventListener('submit', function (event) {
    event.preventDefault();
    const trip = {
      tripName: document.getElementById('tripName').value,
      startDate: document.getElementById('startDate').value,
      endDate: document.getElementById('endDate').value,
      tripDates: []
    };

    document.querySelectorAll('.tripDate').forEach(dateElement => {
      const tripDate = {
        id: dateElement.dataset.id || null,
        tripDate: dateElement.querySelector('.tripDateInput').value,
        tripLocations: []
      };

      dateElement.querySelectorAll('.trip-location').forEach(locationElement => {
        const tripLocation = {
          id: locationElement.dataset.id || null,
          placeName: locationElement.querySelector('.placeNameInput').value,
          latitude: parseFloat(locationElement.querySelector('.latitudeInput').value),
          longitude: parseFloat(locationElement.querySelector('.longitudeInput').value)
        };
        tripDate.tripLocations.push(tripLocation);
      });

      trip.tripDates.push(tripDate);
    });

    fetch(`/api/trips/${tripId}`, {
      method: 'PUT',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify(trip)
    }).then(response => {
      if (response.ok) {
        alert('여행 일정이 성공적으로 수정되었습니다.');
        window.location.href = `/viewtripdetails/${tripId}`;
      } else {
        alert('여행 일정 수정 중 오류가 발생했습니다.');
      }
    });
  });

  function addTripDate(tripDateData = {}) {
    const tripDateId = tripDatesCounter++;
    const tripDateElement = document.createElement('div');
    tripDateElement.className = 'tripDate';
    tripDateElement.dataset.id = tripDateData.id || '';

    tripDateElement.innerHTML = `
          <div class="dayHeader">
              <input type="date" class="tripDateInput" value="${tripDateData.tripDate || ''}" disabled>
              <button type="button" onclick="removeElement(this.parentNode.parentNode)">삭제</button>
          </div>
          <div class="locations">
              ${tripDateData.tripLocations ? tripDateData.tripLocations.map(loc => createTripLocationHtml(loc)).join('') : ''}
          </div>
          <button type="button" onclick="addTripLocation(this.parentNode)">장소 추가</button>
      `;

    document.getElementById('tripDatesContainer').appendChild(tripDateElement);
  }

  function addTripLocation(tripDateElement, tripLocationData = {}) {
    const tripLocationElement = document.createElement('div');
    tripLocationElement.className = 'trip-location';
    tripLocationElement.dataset.id = tripLocationData.id || '';

    tripLocationElement.innerHTML = `
          <input type="text" class="placeNameInput" placeholder="장소 이름" value="${tripLocationData.placeName || ''}">
          <input type="text" class="latitudeInput" placeholder="위도" value="${tripLocationData.latitude || ''}">
          <input type="text" class="longitudeInput" placeholder="경도" value="${tripLocationData.longitude || ''}">
          <button type="button" onclick="removeElement(this.parentNode)">삭제</button>
      `;

    tripDateElement.querySelector('.locations').appendChild(tripLocationElement);
  }

  function removeElement(element) {
    element.parentNode.removeChild(element);
  }

  function createTripLocationHtml(tripLocationData) {
    return `
          <div class="trip-location" data-id="${tripLocationData.id || ''}">
              <input type="text" class="placeNameInput" placeholder="장소 이름" value="${tripLocationData.placeName || ''}">
              <input type="text" class="latitudeInput" placeholder="위도" value="${tripLocationData.latitude || ''}">
              <input type="text" class="longitudeInput" placeholder="경도" value="${tripLocationData.longitude || ''}">
              <button type="button" onclick="removeElement(this.parentNode)">삭제</button>
          </div>
      `;
  }

  function fetchTripData() {
    const tripId = window.location.pathname.split('/').pop();
    fetch(`/api/trips/${tripId}`)
            .then(response => response.json())
            .then(trip => {
              document.getElementById('tripName').value = trip.tripName;
              document.getElementById('startDate').value = trip.startDate;
              document.getElementById('endDate').value = trip.endDate;

              trip.tripDates.forEach(tripDate => addTripDate(tripDate));
            });
  }

  // 페이지 로드 시 여행 데이터를 가져옵니다.
  window.onload = fetchTripData;
</script>
</body>
</html>


