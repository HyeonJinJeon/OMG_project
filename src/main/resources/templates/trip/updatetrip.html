<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>여행 일정 수정</title>
    <link rel="stylesheet" href="/css/trip.css">
    <link rel="stylesheet" href="/css/map.css">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
</head>
<body>
<div class="container">
    <!-- 여행 일정 생성 영역 -->
    <div class="form_wrap">
        <a href="/" class="backLink">↩️ 메인 화면</a>
        <form id="tripForm">
            <h1>여행 일정 수정</h1>
            <label for="tripName">여행 이름</label>
            <input type="text" id="tripName" name="tripName">

            <label for="startDate">여행 시작일</label>
            <input type="date" id="startDate" name="startDate">

            <label for="endDate">여행 종료일</label>
            <input type="date" id="endDate" name="endDate">

            <h2>세부 일정</h2>
            <div id="tripDatesContainer">
                <!-- 여행 날짜 및 장소들이 동적으로 추가될 부분 -->
            </div>
            <button type="submit" id="editButton">수정</button>
        </form>
    </div>

    <!-- 지도 영역 -->
    <div class="map_wrap">
        <div id="map"></div>

        <!-- 검색 메뉴 컨테이너 -->
        <div id="menu_wrap" class="bg_white">
            <div class="option">
                <div>
                    <!-- 검색 폼 제출 시 searchPlaces() 호출 -->
                    <form onsubmit="searchPlaces(); return false;">
                        <input type="text" placeholder="장소명을 입력해주세요." id="keyword" size="15">
                        <button type="submit" id="searchBtn">검색하기</button>
                    </form>
                    <button type="button" id="closeBtn">창 닫기</button>
                </div>
            </div>
            <hr>
            <!-- 장소 목록을 표시할 리스트 -->
            <ul id="placesList"></ul>
            <!-- 페이지네이션을 표시 -->
            <div id="pagination"></div>
        </div>
    </div>
</div>

<script>
    let tripDatesCounter = 0;
    let markers = {};
    let selectedPlaces = {};
    let selectedDateDiv = null;

    document.getElementById('tripForm').addEventListener('submit', function (event) {
        event.preventDefault();
        const trip = {
            tripName: document.getElementById('tripName').value,
            startDate: document.getElementById('startDate').value,
            endDate: document.getElementById('endDate').value,
            tripDates: []
        };

        document.querySelectorAll('.trip-date').forEach(dateElement => {
            const tripDate = {
                id: dateElement.dataset.id || null,
                tripDate: dateElement.querySelector('.tripDateInput').value,
                tripLocations: []
            };

            dateElement.querySelectorAll('.trip-location').forEach(locationElement => {
                const tripLocation = {
                    id: locationElement.dataset.id || null,
                    placeName: locationElement.querySelector('.placeNameInput').value,
                    latitude: parseFloat(locationElement.querySelector('.latitudeInput').value),
                    longitude: parseFloat(locationElement.querySelector('.longitudeInput').value)
                };
                tripDate.tripLocations.push(tripLocation);
            });

            trip.tripDates.push(tripDate);
        });

        fetch(`/api/trips/${tripId}`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(trip)
        }).then(response => {
            if (response.ok) {
                alert('여행 일정이 성공적으로 수정되었습니다.');
                window.location.href = `/trip/update/${tripId}`;
                // window.location.href = '/';
            } else {
                alert('여행 일정 수정 중 오류가 발생했습니다.');
            }
        });
    });

    /**
     * fetchTripData에서 호출되어 각 여행 날짜 동적으로 생성
     * 여행 장소 상세는 createTripLocationHtml에서 생성
     * @param tripDateData
     */
    function addTripDate(tripDateData = {}) {
        const tripDateId = tripDatesCounter++;
        const tripDateElement = document.createElement('div');
        tripDateElement.className = 'trip-date';
        tripDateElement.dataset.id = tripDateData.id || '';

        tripDateElement.innerHTML = `
        <div class="trip-date-title">
          <span class="dayCountLabel">Day ${tripDateId + 1}</span>
          <span> ${tripDateData.tripDate || ''}</span>
          <input type="hidden" class="tripDateInput" value="${tripDateData.tripDate || ''}" disabled>
        </div>
        <div class="trip-locations">
          ${tripDateData.tripLocations ? tripDateData.tripLocations.map((loc, index) => createTripLocationHtml(loc, tripDateId + 1, index + 1)).join('') : ''}
        </div>
        <button type="button" onclick="addTripLocation(this)">장소 추가</button>
      `;

        document.getElementById('tripDatesContainer').appendChild(tripDateElement);

        // 받아온 데이터를 기반으로 selectedPlaces 객체 초기화
        const dayNum = tripDateId + 1;
        if (tripDateData.tripLocations) {   // tripDateData의 tripLocations이 존재한다면
            selectedPlaces[dayNum] = tripDateData.tripLocations.map(loc => ({   // 배열을 순회하면서 객체에 할당
                placeName: loc.placeName,
                latitude: loc.latitude,
                longitude: loc.longitude
            }));

            markers[dayNum] = [];
            tripDateData.tripLocations.forEach((loc) => {
                // 카카오 API 기본 markers와 같게 구현하기 위해 addSavedPlacesMarker를 통해 카카오 API marker 객체로 생성
                addSavedPlacesMarker(loc.latitude, loc.longitude, markers[dayNum].length, dayNum);
            });

        } else {    // tripDateData의 tripLocations이 존재하지 않는다면 해당 날짜에는 장소와 마커가 없으니 빈 배열로 초기화
            selectedPlaces[dayNum] = [];
            markers[dayNum] = [];
        }

        console.log('addTripDate --- selectedPlaces : {}', selectedPlaces);
        console.log('addTripDate --- markers : {}', markers);
        console.log('----------');
    }

    function addTripLocation(button) {
        // 장소 추가 버튼을 누를 시 menu_wrap이 보이도록 설정
        document.getElementById('menu_wrap').style.display = 'block';

        selectedDateDiv = button.closest('.trip-date');

        // 여행 몇째 날인지 추출 (ex. 1, 2, ..)
        if (selectedDateDiv) {
            // Day 정보를 포함하는 span 요소 선택
            const dayCountSpan = selectedDateDiv.querySelector('.dayCountLabel');

            if (dayCountSpan) {
                // "Day 1"과 같은 텍스트를 가져옴
                const dayText = dayCountSpan.textContent.trim();

                // "Day 1"에서 숫자 부분만 추출
                const dayNum = dayText.replace('Day ', '');

                // selectedPlaces 객체에서 dayNum에 해당하는 배열이 없으면 초기화
                if (!selectedPlaces[dayNum]) {
                    selectedPlaces[dayNum] = [];
                }

                if (!markers[dayNum]) {
                    markers[dayNum] = [];
                }

                return dayNum; // 예: "1"
            } else {
                console.error('Day count span not found in selectedDateDiv.');
            }
        } else {
            console.error('selectedDateDiv is not set.');
        }
        return null;

    }

    function handleSelectCompleteBtnClick() {
        if (selectedPlaces.length === 0) {
            alert('선택된 장소가 없습니다. 장소를 추가해 주세요.');
            return;
        }

        if (!selectedDateDiv) {
            alert('장소를 추가할 날짜를 선택해 주세요.');
            return;
        }

        const locationsContainer = selectedDateDiv.querySelector('.trip-locations');
        selectedPlaces.forEach(place => {
            const tripLocationElement = document.createElement('div');
            tripLocationElement.className = 'trip-location';
            tripLocationElement.dataset.id = place.id || '';
            // tripLocationElement.dataset.id = tripLocationData.id || '';
            // const locations = document.createElement('div');
            // locations.className = 'trip-location';
            // locations.dataset.id = place.id || '';

            // 위도와 경도를 소수점 6자리까지 포맷
            const formattedLatitude = parseFloat(place.y).toFixed(6);
            const formattedLongitude = parseFloat(place.x).toFixed(6);

            // locations.innerHTML = `
            tripLocationElement.innerHTML = `
            <div class="placeNameContainer">
                <input type="text" class="placeNameInput" value="${place.place_name}" readonly />
<!--                <button type="button" onclick="removeElement(this.parentNode)">삭제</button>-->
            </div>
            <input type="hidden" class="longitudeInput" value="${formattedLongitude}" />
            <input type="hidden" class="latitudeInput" value="${formattedLatitude}" />
        `;

            locationsContainer.appendChild(tripLocationElement);
            // locationsContainer.appendChild(locations);
        });

        selectedPlaces = [];
        selectedDateDiv = null;
        // 선택 완료 버튼 누를 시 검색창 숨기기
        $('#menu_wrap').hide();
    }

    /**
     * 여행 장소 삭제
     * HTML에서 제거 후 날짜 카운트 업데이트
     * @param element
     */
    // function removeElement(element) {
    //     // // element는 trip-location div
    //     // const locationId = element.dataset.id;
    //     //
    //     // // 화면에서 요소 제거
    //     // element.parentNode.removeChild(element);
    //
    //     // `element`는 삭제 버튼이 포함된 `placeNameContainer`의 참조
    //     const tripLocationElement = element.closest('.trip-location');
    //     if (tripLocationElement) {
    //         tripLocationElement.remove();
    //     }
    //
    //     updateDayCount();
    // }

    /**
     * 장소 상세 HTML 생성
     * @param tripLocationData
     * @param dayNum
     * @param placeIndex
     * @returns {string}
     */
    function createTripLocationHtml(tripLocationData, dayNum, placeIndex) {

        // 장소의 고유 ID 생성 (ex. 몇일차-몇번째장소: 1-1, 1-2, 2-1, ..) 나중에 삭제 시 같은 장소 겹침 문제 해결 위해 고유 ID 지정
        const uniqueId = `${dayNum}-${placeIndex}`;
        const markerImageIndex = (dayNum % 6) === 0 ? 6 : (dayNum % 6);    // 마커 이미지 색상이랑 맞추기 (1 ~ 6 순환)
        const colorCode = getColorCode(markerImageIndex);

        return `
        <div class="trip-location" data-id="${tripLocationData.id || ''}">
          <div class="placeNameContainer">
            <span id="${uniqueId}" style="color: ${colorCode};">${placeIndex}</span>
            <input type="text" class="placeNameInput" placeholder="장소 이름" value="${tripLocationData.placeName || ''}">
            <button type="button" onclick="handleRemoveBtnClick(event, '${uniqueId}', ${tripLocationData.longitude}, ${tripLocationData.latitude})">삭제</button>
          </div>
          <input type="hidden" class="latitudeInput" placeholder="위도" value="${tripLocationData.latitude || ''}">
          <input type="hidden" class="longitudeInput" placeholder="경도" value="${tripLocationData.longitude || ''}">
        </div>
      `;
    }

    /**
     * 여행 데이터 가져와서 HTML에 채워넣음
     */
    function fetchTripData() {
        fetch(`/api/trips/${tripId}`)
            .then(response => response.json())
            .then(trip => {
                document.getElementById('tripName').value = trip.tripName;
                document.getElementById('startDate').value = trip.startDate;
                document.getElementById('endDate').value = trip.endDate;

                trip.tripDates.forEach(tripDate => addTripDate(tripDate));
            });
    }

    /**
     * 날짜 카운트 업데이트 (Day 숫자 업데이트)
     */
    function updateDayCount() {
        const tripDateInputs = document.querySelectorAll('.tripDateInput');
        tripDateInputs.forEach((input, index) => {
            const dayCountLabel = input.parentNode.querySelector('.dayCountLabel');
            if (dayCountLabel) {
                // dayCountLabel이 존재하면 내용을 업데이트
                // dayCountLabel.remove();
                dayCountLabel.textContent = `Day ${index + 1}`;
            } else {
                // 존재하지않으면 새로 생성
                const newDayCountLabel = document.createElement('span');
                newDayCountLabel.className = 'dayCountLabel';
                newDayCountLabel.textContent = `Day ${index + 1}`;
                // input.parentNode.insertBefore(newDayCountLabel, input.nextSibling);
                input.parentNode.insertBefore(newDayCountLabel, input);
            }
        });
    }

    // 페이지 로드 시 여행 데이터를 가져옴
    const tripId = window.location.pathname.split('/').pop();
    fetchTripData();

    // 창 닫기 버튼 클릭 시 #menu_wrap 숨기기
    document.getElementById('closeBtn').addEventListener('click', function() {
        $('#menu_wrap').hide();
    });

    // 날짜 변경 시 일정을 조정하는 함수 추가
    function updateTripDates() {
        const startDate = new Date(document.getElementById('startDate').value);
        const endDate = new Date(document.getElementById('endDate').value);

        if (isNaN(startDate) || isNaN(endDate) || startDate > endDate) {
            alert('유효한 날짜 범위를 선택하세요.');
            return;
        }

        const existingTripDates = document.querySelectorAll('.trip-date');
        const existingTripData = Array.from(existingTripDates).map((dateElement, index) => {
            const tripLocations = Array.from(dateElement.querySelectorAll('.trip-location')).map(locationElement => ({
                placeName: locationElement.querySelector('.placeNameInput').value,
                latitude: parseFloat(locationElement.querySelector('.latitudeInput').value),
                longitude: parseFloat(locationElement.querySelector('.longitudeInput').value)
            }));

            return {
                tripDate: dateElement.querySelector('.tripDateInput').value,
                tripLocations
            };
        });

        const newTripDatesContainer = document.getElementById('tripDatesContainer');
        newTripDatesContainer.innerHTML = '';  // 기존 날짜들을 비움

        let newDateIndex = 0;
        for (let date = new Date(startDate); date <= endDate; date.setDate(date.getDate() + 1)) {
            const tripDateData = existingTripData[newDateIndex] || {};
            const dayNum = newDateIndex + 1;

            // 기존 addTripDate 함수 호출
            addTripDate({
                tripDate: date.toISOString().split('T')[0],
                tripLocations: tripDateData.tripLocations || []
            });

            newDateIndex++;
        }

        // 만약 새로운 날짜 범위가 기존 날짜보다 짧다면, 남는 날짜의 장소들을 마지막 날로 합칩니다.
        if (newDateIndex < existingTripData.length) {
            const lastTripLocations = existingTripData.slice(newDateIndex).flatMap(data => data.tripLocations);
            const lastDayElement = newTripDatesContainer.querySelector('.trip-date:last-child .trip-locations');
            lastDayElement.innerHTML = lastTripLocations.map((loc, index) => createTripLocationHtml(loc, newDateIndex, index + 1)).join('');
        }
    }

    // 날짜 변경 이벤트 리스너 추가
    document.getElementById('startDate').addEventListener('change', updateTripDates);
    document.getElementById('endDate').addEventListener('change', updateTripDates);

</script>
<script type="text/javascript"
        src="//dapi.kakao.com/v2/maps/sdk.js?appkey=c60fdc23b01e5e1886e831583b4cefb0&libraries=services"></script>
<script src="/js/updatetrip.js"></script>
</body>
</html>
